name: ci

on: [push, pull_request]


jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      version-tag: ${{ steps.regex-match.outputs.match }}
    steps:
    - uses: actions-ecosystem/action-regex-match@v2
      id: regex-match
      with:
        text: ${{ github.ref_name }}
        regex: '^v[0-9]+(\.[0-9]+)*(-[a-zA-Z0-9-]+)?$'
    - name: Print setup
      run: |
        echo github.ref=${{ github.ref }}
        echo github.ref_name=${{ github.ref_name }}
        echo github.ref_type=${{ github.ref_type }}
        echo release-ref=${{ steps.regex-match.outputs.match }}

  publish-ghcr:
    needs: [setup]
    runs-on: ubuntu-latest
    if: ${{ ( github.ref_type == 'branch' ) && (( github.ref_name == 'master' ) || ( github.ref_name == 'v0' ) || ( github.ref_name == 'DP-556-add-make-to-topcctl-image' )) }}
    steps:
    - uses: actions/checkout@v3
    - name: setup env variables
      id: vars
      run: |
        echo "SHORT_SHA=${GITHUB_SHA:0:8}" >> $GITHUB_ENV
    - run: echo "publishing the image ghcr.io/segmentio/topicctl:${SHORT_SHA}"
    - name: Log in to the Container registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        logout: true
    - run: echo "GHCR LOGIN SUCCESSFUL"
    - if: ${{ github.ref_name == 'master' }}
      name: Build and push image for master
      run:  |
        docker context create buildx-build
        docker buildx create --use buildx-build
        docker buildx build \
          -t ghcr.io/segmentio/topicctl:${SHORT_SHA} \
          -t ghcr.io/segmentio/topicctl:latest \
          --build-arg VERSION=${SHORT_SHA} \
          --push \
          .
    - if: ${{ github.ref_name == 'v0' }}
      name: Build and push image for v0
      run:  |
        docker context create buildx-build
        docker buildx create --use buildx-build
        docker buildx build \
          -t ghcr.io/segmentio/topicctl:${SHORT_SHA} \
          --build-arg VERSION=${SHORT_SHA} \
          --push \
          .
    - if: ${{ github.ref_name == 'DP-556-add-make-to-topcctl-image' }}
      name: Build and push image for DP-556-add-make-to-topcctl-image
      run:  |
        docker context create buildx-build
        docker buildx create --use buildx-build
        docker buildx build \
          -t ghcr.io/segmentio/topicctl:test-make \
          --build-arg VERSION=${SHORT_SHA} \
          --push \
          .
    - run: echo "GHCR PUBLISH SUCCESSFUL"
